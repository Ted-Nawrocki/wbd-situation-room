name: Update market quotes (WBD, NFLX, PSKY)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * 1-5"  # every 30 min, Monâ€“Fri (UTC)

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Fetch quotes from Stooq and write JSON
        run: |
          set -e
          mkdir -p assets/data

          fetch_one () {
            local SYMBOL="$1"
            local OUTFILE="$2"

            curl -s "https://stooq.com/q/l/?s=${SYMBOL}&f=sd2t2ohlcv&h&e=csv" > /tmp/q.csv

            python3 - <<'PY'
          import csv, json, datetime, os
          from pathlib import Path

          symbol = os.environ["SYMBOL"]
          outfile = os.environ["OUTFILE"]

          rows = list(csv.reader(Path("/tmp/q.csv").read_text().strip().splitlines()))
          if len(rows) < 2:
              raise SystemExit(f"No data returned from Stooq for {symbol}")

          r = rows[1]  # Symbol,Date,Time,Open,High,Low,Close,Volume
          data = {
              "symbol": r[0],
              "date": r[1],
              "time": r[2],
              "open": r[3],
              "high": r[4],
              "low": r[5],
              "close": r[6],
              "volume": r[7],
              "asof_utc": datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z",
              "source": "stooq"
          }

          Path(outfile).write_text(json.dumps(data, indent=2) + "\n")
          print("Wrote", outfile)
          PY
          }

          # WBD + NFLX
          SYMBOL="wbd.us"  OUTFILE="assets/data/wbd.json"  fetch_one "$SYMBOL" "$OUTFILE"
          SYMBOL="nflx.us" OUTFILE="assets/data/nflx.json" fetch_one "$SYMBOL" "$OUTFILE"

          # PSKY: try primary symbol, fall back to variant if Stooq uses it
          (SYMBOL="psky.us"    OUTFILE="assets/data/psky.json" fetch_one "$SYMBOL" "$OUTFILE") || \
          (SYMBOL="psky_mv.us" OUTFILE="assets/data/psky.json" fetch_one "$SYMBOL" "$OUTFILE")

      - name: Commit and push if changed
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/data/wbd.json assets/data/nflx.json assets/data/psky.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Update market quotes"
          git push
