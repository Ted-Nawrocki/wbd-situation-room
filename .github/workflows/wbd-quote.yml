name: Update WBD quote

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * 1-5"  # every 30 min, Monâ€“Fri (UTC)

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Fetch quote from Stooq and write JSON
        run: |
          set -e
          mkdir -p assets/data
          curl -s "https://stooq.com/q/l/?s=wbd.us&f=sd2t2ohlcv&h&e=csv" > /tmp/wbd.csv
          python3 - <<'PY'
          import csv, json, datetime
          from pathlib import Path

          rows = list(csv.reader(Path("/tmp/wbd.csv").read_text().strip().splitlines()))
          if len(rows) < 2:
              raise SystemExit("No data returned from Stooq")

          # Symbol,Date,Time,Open,High,Low,Close,Volume
          r = rows[1]
          data = {
              "symbol": r[0],
              "date": r[1],
              "time": r[2],
              "open": r[3],
              "high": r[4],
              "low": r[5],
              "close": r[6],
              "volume": r[7],
              "asof_utc": datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z",
              "source": "stooq"
          }

          Path("assets/data/wbd.json").write_text(json.dumps(data, indent=2) + "\n")
          print("Updated assets/data/wbd.json")
          PY

      - name: Commit and push if changed
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/data/wbd.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Update WBD quote"
          git push
